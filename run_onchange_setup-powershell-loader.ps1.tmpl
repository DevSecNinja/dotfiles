# PowerShell script to set up profile loader
# Runs when this script changes, placing the signed profile at the correct $PROFILE location
# This handles OneDrive-redirected Documents folders correctly

$ErrorActionPreference = "Stop"

# This script copies the signed Microsoft.PowerShell_profile.ps1 from Documents\PowerShell to the default $PROFILE location.
# This preserves the digital signature and avoids rewriting the loader content.

$sourceProfile = Join-Path -Path ([Environment]::GetFolderPath('MyDocuments')) -ChildPath 'PowerShell\Microsoft.PowerShell_profile.ps1'
$targetProfile = $PROFILE

# Create the profile directory if it doesn't exist
$profileDir = Split-Path -Parent $targetProfile
if (-not (Test-Path $profileDir)) {
    Write-Host "Creating PowerShell profile directory: $profileDir" -ForegroundColor Yellow
    New-Item -ItemType Directory -Path $profileDir -Force | Out-Null
}

if (Test-Path $sourceProfile) {
    Write-Host "Copying signed profile from: $sourceProfile to $targetProfile" -ForegroundColor Cyan
    Copy-Item -Path $sourceProfile -Destination $targetProfile -Force
    Write-Host "âœ… PowerShell profile loader configured successfully (signature preserved)" -ForegroundColor Green
} else {
    Write-Warning "Source profile not found at $sourceProfile. Cannot copy signed profile."
}

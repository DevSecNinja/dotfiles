# PowerShell script to set up profile loader
# Runs when this script changes, placing the loader at the correct $PROFILE location
# This handles OneDrive-redirected Documents folders correctly

$ErrorActionPreference = "Stop"

# The loader content that sources the actual config
$loaderContent = @'
# PowerShell profile loader
# This file is managed by chezmoi and placed at the default PowerShell profile location
# It sources the actual configuration from ~/.config/powershell/profile.ps1

$configPath = "$env:USERPROFILE\.config\powershell\profile.ps1"

if (Test-Path $configPath) {
    . $configPath
} else {
    Write-Warning "PowerShell configuration not found at $configPath"
}
'@

# Get the actual profile location (handles OneDrive redirects)
$profilePath = $PROFILE

# Create the profile directory if it doesn't exist
$profileDir = Split-Path -Parent $profilePath
if (-not (Test-Path $profileDir)) {
    Write-Host "Creating PowerShell profile directory: $profileDir" -ForegroundColor Yellow
    New-Item -ItemType Directory -Path $profileDir -Force | Out-Null
}

# Write the loader content to the profile location
Write-Host "Setting up PowerShell profile loader at: $profilePath" -ForegroundColor Cyan
Set-Content -Path $profilePath -Value $loaderContent -Encoding UTF8 -Force

Write-Host "âœ… PowerShell profile loader configured successfully" -ForegroundColor Green

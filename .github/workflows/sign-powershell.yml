name: Sign PowerShell Scripts

on:
  push:
    branches: [main]
    paths:
      - '**.ps1'
      - '!**.ps1.tmpl'  # Exclude templates - they change after chezmoi processing
  pull_request:
    paths:
      - '**.ps1'
      - '!**.ps1.tmpl'
  workflow_dispatch:

jobs:
  sign-scripts:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Import code signing certificate
        shell: powershell
        env:
          CERT_BASE64: ${{ secrets.CODE_SIGNING_CERT }}
          CERT_PASSWORD: ${{ secrets.CODE_SIGNING_PASSWORD }}
        run: |
          # Decode certificate
          $certBytes = [Convert]::FromBase64String($env:CERT_BASE64)
          $certPath = Join-Path $env:TEMP "cert.pfx"
          [IO.File]::WriteAllBytes($certPath, $certBytes)

          # Import certificate
          $password = ConvertTo-SecureString -String $env:CERT_PASSWORD -Force -AsPlainText
          $cert = Import-PfxCertificate -FilePath $certPath -CertStoreLocation Cert:\CurrentUser\My -Password $password

          # Store thumbprint for signing
          echo "CERT_THUMBPRINT=$($cert.Thumbprint)" >> $env:GITHUB_ENV

          # Cleanup
          Remove-Item $certPath

      - name: Sign PowerShell scripts
        shell: powershell
        run: |
          # Find all .ps1 files (exclude .ps1.tmpl - they are templates that change after processing)
          $scripts = Get-ChildItem -Path . -Recurse -Include "*.ps1" -Exclude "*.ps1.tmpl" | Where-Object {
            $_.FullName -notmatch '[\\/]\.git[\\/]'
          }

          Write-Host "Found $($scripts.Count) PowerShell scripts to sign (excluding .ps1.tmpl templates)"

          $cert = Get-Item "Cert:\CurrentUser\My\$env:CERT_THUMBPRINT"
          $signed = 0
          $alreadySigned = 0

          foreach ($script in $scripts) {
            try {
              # Check if already signed with a valid signature
              $signature = Get-AuthenticodeSignature -FilePath $script.FullName

              if ($signature.Status -eq 'Valid' -and $signature.SignerCertificate.Thumbprint -eq $cert.Thumbprint) {
                Write-Host "  Already signed: $($script.Name)"
                $alreadySigned++
                continue
              }

              # Sign the script
              $result = Set-AuthenticodeSignature -FilePath $script.FullName -Certificate $cert -TimestampServer "http://timestamp.digicert.com"

              if ($result.Status -eq 'Valid') {
                Write-Host "✓ Signed: $($script.Name)"
                $signed++
              } else {
                Write-Warning "✗ Signing failed: $($script.Name) - Status: $($result.Status)"
              }
            }
            catch {
              Write-Warning "✗ Failed to sign: $($script.Name) - $_"
            }
          }

          Write-Host "`n==================================="
          Write-Host "Summary:"
          Write-Host "  Total scripts: $($scripts.Count)"
          Write-Host "  Already signed: $alreadySigned"
          Write-Host "  Newly signed: $signed"
          Write-Host "==================================="

      - name: Check for changes
        id: check_changes
        shell: bash
        run: |
          if git diff --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected - all scripts already signed"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected - scripts were signed"
          fi

      - name: Commit signed scripts
        if: steps.check_changes.outputs.changes == 'true' && github.event_name != 'pull_request'
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "*.ps1"
          git commit -m "chore: sign PowerShell scripts [skip ci]"
          git push

      - name: Comment on PR
        if: steps.check_changes.outputs.changes == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ PowerShell scripts have been signed. Please pull the latest changes after merge.'
            })

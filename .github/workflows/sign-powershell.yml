name: Sign PowerShell Scripts

on:
  push:
    branches: [main]
    paths:
      - '**.ps1'
      - '!**.ps1.tmpl'  # Exclude templates - they change after chezmoi processing
  pull_request:
    paths:
      - '**.ps1'
      - '!**.ps1.tmpl'
  workflow_dispatch:

jobs:
  sign-scripts:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sign PowerShell scripts
        shell: powershell
        env:
          CERT_BASE64: ${{ secrets.CODE_SIGNING_CERT }}
          CERT_PASSWORD: ${{ secrets.CODE_SIGNING_PASSWORD }}
        run: |
          # Load the signing script
          $signingScript = Join-Path $PWD "dot_local/private_bin/scripts/powershell/Sign-PowerShellScripts.ps1"

          if (-not (Test-Path $signingScript)) {
            Write-Error "Sign-PowerShellScripts.ps1.tmpl not found at: $signingScript"
            exit 1
          }

          # Convert password to SecureString
          $securePassword = ConvertTo-SecureString -String $env:CERT_PASSWORD -Force -AsPlainText

          # Execute the signing script
          $stats = & $signingScript `
            -CertificateBase64 $env:CERT_BASE64 `
            -CertificatePassword $securePassword `
            -Path $PWD `
            -Exclude "*.ps1.tmpl"

          # Exit with error if any scripts failed to sign
          if ($stats.Failed -gt 0) {
            Write-Error "Failed to sign $($stats.Failed) script(s)"
            exit 1
          }

      - name: Check for changes
        id: check_changes
        shell: bash
        run: |
          if git diff --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected - all scripts already signed"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected - scripts were signed"
          fi

      - name: Commit signed scripts
        if: steps.check_changes.outputs.changes == 'true' && github.event_name != 'pull_request'
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "*.ps1"
          git commit -m "chore: sign PowerShell scripts [skip ci]"
          git push

      - name: Comment on PR
        if: steps.check_changes.outputs.changes == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… PowerShell scripts have been signed. Please pull the latest changes after merge.'
            })

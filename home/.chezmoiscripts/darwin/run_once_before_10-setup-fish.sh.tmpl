#!/bin/bash
# Setup Fish shell as default shell on macOS
#
# This script:
# 1. Detects the correct Fish installation path (Apple Silicon vs Intel)
# 2. Adds Fish to /etc/shells if not already present
# 3. Sets Fish as the default shell using chsh
#
# Note: This script requires sudo access for modifying /etc/shells

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# Logging functions
log_info() {
    echo -e "${WHITE}ℹ️  $*${NC}"
}

log_success() {
    echo -e "${GREEN}✅ $*${NC}"
}

log_warning() {
    echo -e "${YELLOW}⚠️  $*${NC}"
}

log_error() {
    echo -e "${RED}❌ $*${NC}"
}

# Only run on macOS
if [[ "{{ .chezmoi.os }}" != "darwin" ]]; then
    log_info "Skipping Fish shell setup (not on macOS)"
    exit 0
fi

log_info "Setting up Fish shell on macOS..."

# Detect Fish installation path
# Apple Silicon Macs: /opt/homebrew/bin/fish
# Intel Macs: /usr/local/bin/fish
FISH_PATH=""
if [[ -x "/opt/homebrew/bin/fish" ]]; then
    FISH_PATH="/opt/homebrew/bin/fish"
    log_info "Detected Fish at: $FISH_PATH (Apple Silicon)"
elif [[ -x "/usr/local/bin/fish" ]]; then
    FISH_PATH="/usr/local/bin/fish"
    log_info "Detected Fish at: $FISH_PATH (Intel)"
else
    log_error "Fish shell not found at /opt/homebrew/bin/fish or /usr/local/bin/fish"
    log_info "Please install Fish using: brew install fish"
    exit 1
fi

# Verify Fish version
FISH_VERSION=$("$FISH_PATH" --version 2>/dev/null | awk '{print $3}')
log_info "Found Fish version: $FISH_VERSION"

# Check if Fish is already in /etc/shells
if grep -q "^${FISH_PATH}$" /etc/shells 2>/dev/null; then
    log_success "Fish is already in /etc/shells"
else
    log_warning "Fish is not in /etc/shells, adding it now..."
    log_info "This requires sudo access"

    if echo "$FISH_PATH" | sudo tee -a /etc/shells >/dev/null; then
        log_success "Added $FISH_PATH to /etc/shells"
    else
        log_error "Failed to add Fish to /etc/shells"
        exit 1
    fi
fi

# Check current shell
CURRENT_SHELL=$(dscl . -read ~/ UserShell | awk '{print $2}')
log_info "Current shell: $CURRENT_SHELL"

# Change default shell to Fish if not already set
if [[ "$CURRENT_SHELL" == "$FISH_PATH" ]]; then
    log_success "Fish is already your default shell"
else
    log_warning "Changing default shell to Fish..."

    if chsh -s "$FISH_PATH"; then
        log_success "Default shell changed to Fish"
        log_info "Please restart your terminal for the changes to take effect"
    else
        log_error "Failed to change default shell to Fish"
        log_info "You can manually change it later with: chsh -s $FISH_PATH"
        exit 1
    fi
fi

log_success "Fish shell setup completed successfully!"
echo ""
log_info "Next steps:"
echo "  1. Restart your terminal"
echo "  2. Verify by running: echo \$SHELL"

{{- if eq .chezmoi.os "windows" -}}
# Source PowerShell functions from chezmoi source directory
$functionsPath = "{{ .chezmoi.sourceDir }}\dot_config\powershell\functions.ps1"
if (-not (Test-Path $functionsPath)) {
    Write-Error "Functions file not found at: $functionsPath"
    exit 1
}
. $functionsPath

Write-Host "`nInstalling PowerShell Repositories..." -ForegroundColor Cyan
Set-PSResourceRepository -Name "PSGallery" -Priority 25 -Trusted #-PassThru

Write-Host "`nInstalling PowerShell Resources..." -ForegroundColor Cyan
Install-PSResource -Name NerdFonts -Scope CurrentUser

Write-Host "`nInstalling PowerShell Fonts..." -ForegroundColor Cyan
# Install-NerdFont -Name FiraCode -Scope CurrentUser -Force

# chezmoi uses Windows PowerShell which throws 'CouldNotAutoloadMatchingModule'
# TODO: Make nice function for calling pwsh non-interactive. Also reuse in Install-PowerShellModule file.
# TODO: Move font install after installing packages since package install will install pwsh
# TODO: Make nice font install function that checks if font was installed successfully
pwsh -NoProfile -NonInteractive -Command "Install-NerdFont -Name FiraCode -Scope CurrentUser" 2>&1

Write-Host "`nInstalling PowerShell Modules..." -ForegroundColor Cyan

# Install light mode modules (always)
{{- range .packages.windows.powershell_modules.light }}
Install-PowerShellModule -ModuleName {{ . | quote }} | Out-Null
{{- end }}

{{- if eq .installType "full" }}
# Install full mode modules (additional)
{{- range .packages.windows.powershell_modules.full }}
Install-PowerShellModule -ModuleName {{ . | quote }} | Out-Null
{{- end }}
{{- end }}

Write-Host "`n[COMPLETE] All PowerShell modules installation finished!" -ForegroundColor Green
{{- end }}

{{- if eq .chezmoi.os "windows" -}}
# Function to install PowerShell modules using pwsh -Command
function Install-PowerShellModule {
    param (
        [string]$ModuleName
    )
    
    Write-Host "Installing module '$($ModuleName)'..." -NoNewline
    $result = pwsh -NoProfile -NonInteractive -Command "`$module = Install-Module -Name $ModuleName -Scope CurrentUser -Force -AllowClobber -SkipPublisherCheck -ErrorAction SilentlyContinue -PassThru 2>&1; if (`$module) { `$module | Select-Object Name, Version | Format-Table -HideTableHeaders | Out-String } else { Write-Error 'Module installation failed' }" 2>&1
    
    if ($LASTEXITCODE -eq 0) {
        if ($result) {
            # Parse the output to extract module name and version
            $parsed = $result.Trim().Split(" ") | Where-Object {$_ -ne ""}
            if ($parsed.Count -ge 2) {
                $moduleInfo = [PSCustomObject]@{
                    Name = $parsed[0]
                    Version = $parsed[1]
                }
                Write-Host " [OK] Installed $($moduleInfo.Name) $($moduleInfo.Version)" -ForegroundColor Green
                return $moduleInfo
            }
        }
    } else {
        Write-Host " [FAILED]" -ForegroundColor Red
        Write-Error "Module installation failed: $result"
        return $null
    }
}

Write-Host "`nInstalling PowerShell modules..." -ForegroundColor Cyan

# Install light mode modules (always)
{{- range .packages.windows.powershell_modules.light }}
Install-PowerShellModule -ModuleName {{ . | quote }} | Out-Null
{{- end }}

{{- if eq .installType "full" }}
# Install full mode modules (additional)
{{- range .packages.windows.powershell_modules.full }}
Install-PowerShellModule -ModuleName {{ . | quote }} | Out-Null
{{- end }}
{{- end }}

Write-Host "`n[COMPLETE] All PowerShell modules installation finished!" -ForegroundColor Green
{{- end }}
# {{ if eq .chezmoi.os "windows" }}
# Source PowerShell functions from DotfilesHelpers module in chezmoi source directory
$modulePath = "{{ .chezmoi.sourceDir }}\dot_config\powershell\modules\DotfilesHelpers"
if (Test-Path $modulePath) {
    Import-Module $modulePath -Force -DisableNameChecking
}
else {
    Write-Error "DotfilesHelpers module not found at: $modulePath"
    exit 1
}

Write-Host "`nInstalling PowerShell Repositories..." -ForegroundColor Cyan
Set-PSResourceRepository -Name "PSGallery" -Priority 25 -Trusted #-PassThru

Write-Host "`nInstalling PowerShell Fonts..." -ForegroundColor Cyan

# chezmoi uses Windows PowerShell which throws 'CouldNotAutoloadMatchingModule'
# TODO: Make nice function for calling pwsh non-interactive. Also reuse in Install-PowerShellModule file.
# TODO: Move font install after installing packages since package install will install pwsh
# TODO: Make nice font install function that checks if font was installed successfully
pwsh -NoProfile -NonInteractive -Command "Install-PSResource -Name NerdFonts -Scope CurrentUser && Install-NerdFont -Name FiraCode -Scope CurrentUser" 2>&1

Write-Host "`nInstalling PowerShell Modules..." -ForegroundColor Cyan

# Install light mode modules (always)
# {{ range .packages.windows.powershell_modules.light }}
Install-PowerShellModule -ModuleName {{ . | quote }} | Out-Null
# {{ end }}

# {{ if eq .installType "full" }}
# Install full mode modules (additional)
# {{ range .packages.windows.powershell_modules.full }}
Install-PowerShellModule -ModuleName {{ . | quote }} | Out-Null
# {{ end }}

# Install Git-based PowerShell modules (full mode only)
Write-Host "`nInstalling Git-based PowerShell Modules..." -ForegroundColor Cyan
# {{ range .packages.windows.powershell_git_modules.full }}
Install-GitPowerShellModule -Name {{ .name | quote }} -Url {{ .url | quote }} -Destination {{ .destination | quote }} | Out-Null
# {{ end }}
# {{ end }}

Write-Host "`n[COMPLETE] All PowerShell modules installation finished!" -ForegroundColor Green
# {{ end }}

{{- if and (eq .chezmoi.os "windows") (eq .installType "full") -}}
# PowerShell script to install and configure WSL 2 with Debian
# Only runs on Windows in full installation mode

$ErrorActionPreference = "Stop"

Write-Host "üêß Setting up WSL (Windows Subsystem for Linux)..." -ForegroundColor Cyan

# Check if running with admin privileges
$isAdmin = ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)

if (-not $isAdmin) {
    Write-Host "‚ö†Ô∏è  WSL installation requires administrator privileges." -ForegroundColor Yellow
    Write-Host "Please run the following command in an elevated PowerShell:" -ForegroundColor Yellow
    Write-Host "  wsl --install -d Debian" -ForegroundColor Cyan
    exit 0
}

# Function to check if WSL is installed
function Test-WSLInstalled {
    try {
        $wslCommand = Get-Command wsl.exe -ErrorAction SilentlyContinue
        return $null -ne $wslCommand
    }
    catch {
        return $false
    }
}

# Function to get WSL version
function Get-WSLVersion {
    try {
        $wslStatus = wsl.exe --status 2>&1
        if ($wslStatus -match "Default Version:\s*(\d+)") {
            return [int]$matches[1]
        }
        return 0
    }
    catch {
        return 0
    }
}

# Function to check if a distribution is installed
function Test-WSLDistroInstalled {
    param([string]$DistroName)
    
    try {
        $distros = wsl.exe --list --quiet 2>&1 | Where-Object { $_ -match '\S' }
        return $distros -match $DistroName
    }
    catch {
        return $false
    }
}

# Function to get default WSL distribution
function Get-WSLDefaultDistro {
    try {
        $distros = wsl.exe --list --verbose 2>&1
        foreach ($line in $distros) {
            if ($line -match '\*\s+(\S+)') {
                return $matches[1]
            }
        }
        return $null
    }
    catch {
        return $null
    }
}

# Check if WSL is already installed
$wslInstalled = Test-WSLInstalled

if (-not $wslInstalled) {
    Write-Host "Installing WSL..." -ForegroundColor Yellow
    
    try {
        # Install WSL using wsl.exe --install
        Write-Host "Running: wsl --install --no-distribution" -ForegroundColor Cyan
        wsl.exe --install --no-distribution
        
        if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå WSL installation failed with exit code $LASTEXITCODE" -ForegroundColor Red
            Write-Host "You may need to restart your computer and run this script again." -ForegroundColor Yellow
            exit 1
        }
        
        Write-Host "‚úÖ WSL installed successfully" -ForegroundColor Green
        Write-Host "‚ö†Ô∏è  You may need to restart your computer for WSL to work properly." -ForegroundColor Yellow
    }
    catch {
        Write-Host "‚ùå Failed to install WSL: $_" -ForegroundColor Red
        Write-Host "You may need to enable WSL features manually:" -ForegroundColor Yellow
        Write-Host "  1. Open PowerShell as Administrator" -ForegroundColor Yellow
        Write-Host "  2. Run: wsl --install" -ForegroundColor Yellow
        exit 1
    }
}
else {
    Write-Host "‚úÖ WSL is already installed" -ForegroundColor Green
}

# Check WSL version
$wslVersion = Get-WSLVersion
Write-Host "WSL version: $wslVersion" -ForegroundColor Cyan

if ($wslVersion -eq 1) {
    Write-Host "‚ö†Ô∏è  WARNING: WSL version 1 detected!" -ForegroundColor Yellow
    Write-Host "WSL 2 is recommended for better performance and compatibility." -ForegroundColor Yellow
    Write-Host "To upgrade to WSL 2:" -ForegroundColor Yellow
    Write-Host "  1. Run: wsl --set-default-version 2" -ForegroundColor Cyan
    Write-Host "  2. Convert existing distros: wsl --set-version <distro> 2" -ForegroundColor Cyan
    Write-Host "More info: https://learn.microsoft.com/en-us/windows/wsl/install" -ForegroundColor Yellow
}
elseif ($wslVersion -eq 2) {
    Write-Host "‚úÖ WSL 2 is active" -ForegroundColor Green
}

# Check if Debian is installed
$debianInstalled = Test-WSLDistroInstalled "Debian"

if (-not $debianInstalled) {
    Write-Host "`nInstalling Debian distribution..." -ForegroundColor Yellow
    
    try {
        Write-Host "Running: wsl --install -d Debian" -ForegroundColor Cyan
        wsl.exe --install -d Debian
        
        if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå Debian installation failed with exit code $LASTEXITCODE" -ForegroundColor Red
            Write-Host "You can install it manually using:" -ForegroundColor Yellow
            Write-Host "  wsl --install -d Debian" -ForegroundColor Cyan
            exit 1
        }
        
        Write-Host "‚úÖ Debian installed successfully" -ForegroundColor Green
    }
    catch {
        Write-Host "‚ùå Failed to install Debian: $_" -ForegroundColor Red
        exit 1
    }
}
else {
    Write-Host "‚úÖ Debian is already installed" -ForegroundColor Green
}

# Set Debian as default distribution
$currentDefault = Get-WSLDefaultDistro

if ($currentDefault -ne "Debian") {
    Write-Host "`nSetting Debian as default WSL distribution..." -ForegroundColor Yellow
    
    try {
        wsl.exe --set-default Debian
        
        if ($LASTEXITCODE -eq 0) {
            Write-Host "‚úÖ Debian set as default distribution" -ForegroundColor Green
        }
        else {
            Write-Host "‚ö†Ô∏è  Failed to set Debian as default (exit code: $LASTEXITCODE)" -ForegroundColor Yellow
        }
    }
    catch {
        Write-Host "‚ö†Ô∏è  Failed to set Debian as default: $_" -ForegroundColor Yellow
    }
}
else {
    Write-Host "‚úÖ Debian is already the default distribution" -ForegroundColor Green
}

Write-Host "`nüéâ WSL setup complete!" -ForegroundColor Green
Write-Host "üí° To launch Debian, run: wsl" -ForegroundColor Yellow
Write-Host "üí° To see all installed distributions, run: wsl --list --verbose" -ForegroundColor Yellow
Write-Host "üí° For more information: https://learn.microsoft.com/en-us/windows/wsl/" -ForegroundColor Yellow

{{- end }}

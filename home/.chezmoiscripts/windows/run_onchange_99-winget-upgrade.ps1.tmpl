{{- if eq .chezmoi.os "windows" -}}
#Requires -Version 5.1
<#
.SYNOPSIS
    Runs winget package upgrades when chezmoi detects changes.

.DESCRIPTION
    This script automatically checks for and upgrades winget packages during chezmoi update.
    It runs as the final script (99-) to allow cancellation if needed.

    Features:
    - Detection phase: Only runs if updates are available
    - Execution phase: 3-second countdown before upgrading (can be cancelled)
    - Uses Microsoft.WinGet.Client PowerShell module when available
    - Falls back to winget.exe if module is not installed
    - Warns if neither is available

.NOTES
    - This is a run_onchange script, triggered when this file or its dependencies change
    - Requires Microsoft.WinGet.Client module (automatically installed via packages.yaml)
    - Run order: 99- ensures this is the last script to execute
    - Compatible with both PowerShell Core (7+) and Windows PowerShell (5.1+)

.LINK
    https://www.powershellgallery.com/packages/Microsoft.WinGet.Client
#>

# Hash of dependencies to trigger re-run on changes
# packages.yaml hash: {{ include ".chezmoidata/packages.yaml" | sha256sum }}
# functions.ps1 hash: {{ include "dot_config/powershell/functions.ps1" | sha256sum }}

$ErrorActionPreference = "Continue"  # Continue on errors to avoid blocking chezmoi

Write-Host "`nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
Write-Host "ğŸ”„ Winget Package Upgrade (Chezmoi OnChange)" -ForegroundColor Cyan
Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan

# Source PowerShell functions from chezmoi directory
$functionsPath = "{{ .chezmoi.sourceDir }}\dot_config\powershell\functions.ps1"
if (Test-Path $functionsPath) {
    try {
        . $functionsPath
    }
    catch {
        Write-Warning "Failed to load functions from $functionsPath : $_"
        Write-Warning "Continuing without functions..."
    }
}
else {
    Write-Warning "Functions file not found at: $functionsPath"
    Write-Warning "Some functionality may not be available."
}

# Check if Microsoft.WinGet.Client module is available
$wingetModule = Get-Module -Name Microsoft.WinGet.Client -ListAvailable -ErrorAction SilentlyContinue

if (-not $wingetModule) {
    Write-Host "`nâš ï¸  Microsoft.WinGet.Client module not found" -ForegroundColor Yellow
    Write-Host "   This module should be installed automatically via packages.yaml" -ForegroundColor Gray
    Write-Host "   To install manually: Install-Module -Name Microsoft.WinGet.Client" -ForegroundColor Gray

    # Check if winget.exe is available as fallback
    if (-not (Get-Command winget -ErrorAction SilentlyContinue)) {
        Write-Host "`nâŒ Neither Microsoft.WinGet.Client nor winget.exe is available" -ForegroundColor Red
        Write-Host "   Skipping winget upgrade. Please install one of the following:" -ForegroundColor Red
        Write-Host "   1. Microsoft.WinGet.Client module: Install-Module -Name Microsoft.WinGet.Client" -ForegroundColor Gray
        Write-Host "   2. App Installer from Microsoft Store (includes winget.exe)" -ForegroundColor Gray
        exit 0
    }

    Write-Host "   Using winget.exe as fallback..." -ForegroundColor Yellow
}
else {
    Write-Host "`nâœ… Microsoft.WinGet.Client module found (v$($wingetModule.Version))" -ForegroundColor Green
}

# Check if functions are available (only if we successfully sourced them)
if (Get-Command Test-WingetUpdates -ErrorAction SilentlyContinue) {
    # Use the function from functions.ps1
    try {
        Invoke-WingetUpgrade -CountdownSeconds 3 -UseWingetModule $true
    }
    catch {
        Write-Error "Failed to run Invoke-WingetUpgrade: $_"
        exit 1
    }
}
else {
    # Fallback: Manual implementation if functions not available
    Write-Host "`nğŸ“‹ Detection Phase: Checking for updates..." -ForegroundColor Yellow

    $hasUpdates = $false

    if ($wingetModule) {
        try {
            Import-Module Microsoft.WinGet.Client -ErrorAction Stop
            $updates = Get-WinGetPackage -Source winget | Where-Object { $_.IsUpdateAvailable }

            if ($updates -and $updates.Count -gt 0) {
                Write-Host "âœ… Found $($updates.Count) package update(s) available" -ForegroundColor Green
                $hasUpdates = $true
            }
            else {
                Write-Host "âœ… All packages are up to date" -ForegroundColor Green
            }
        }
        catch {
            Write-Warning "Failed to check updates with module: $_"
            Write-Warning "Trying winget.exe..."
        }
    }

    if (-not $hasUpdates -and (Get-Command winget -ErrorAction SilentlyContinue)) {
        $result = winget upgrade --source winget 2>&1 | Out-String

        if ($result -notmatch "No applicable upgrade found" -and $result -notmatch "No installed package") {
            $hasUpdates = $true
        }
    }

    if (-not $hasUpdates) {
        Write-Host "`nâœ… No updates available. Skipping upgrade." -ForegroundColor Green
        exit 0
    }

    # Countdown phase
    Write-Host "`nâ±ï¸  Execution Phase: Starting upgrade in 3 seconds..." -ForegroundColor Yellow
    Write-Host "   Press Ctrl+C to cancel" -ForegroundColor Gray

    for ($i = 3; $i -gt 0; $i--) {
        Write-Host "   $i..." -NoNewline -ForegroundColor Yellow
        Start-Sleep -Seconds 1
    }
    Write-Host " GO!" -ForegroundColor Green

    # Execution phase
    Write-Host "`nğŸš€ Starting package upgrades..." -ForegroundColor Cyan

    if ($wingetModule) {
        try {
            Import-Module Microsoft.WinGet.Client -ErrorAction Stop
            $packagesToUpdate = Get-WinGetPackage -Source winget | Where-Object { $_.IsUpdateAvailable }

            foreach ($package in $packagesToUpdate) {
                Write-Host "   Upgrading $($package.Name)..." -NoNewline
                try {
                    Update-WinGetPackage -Id $package.Id -Source winget -Mode Silent -Force -ErrorAction Stop | Out-Null
                    Write-Host " âœ…" -ForegroundColor Green
                }
                catch {
                    Write-Host " âŒ" -ForegroundColor Red
                    Write-Warning "Failed to upgrade $($package.Name): $_"
                }
            }
        }
        catch {
            Write-Warning "Module upgrade failed, trying winget.exe..."
            winget upgrade --all --source winget --silent --accept-package-agreements --accept-source-agreements
        }
    }
    else {
        winget upgrade --all --source winget --silent --accept-package-agreements --accept-source-agreements
    }
}

Write-Host "`nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
Write-Host "âœ… Winget upgrade check completed" -ForegroundColor Green
Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan

exit 0
{{- end }}

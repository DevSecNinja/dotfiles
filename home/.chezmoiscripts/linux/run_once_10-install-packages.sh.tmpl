#!/bin/bash
# This script installs packages defined in .chezmoidata/packages.yaml
# Light mode: installs essential packages only
# Full mode: installs light + additional development packages

set -e

echo "ðŸ”§ Installing development tools ({{ .installType }} mode)..."

{{- if eq .chezmoi.os "linux" }}
    {{- if eq .chezmoi.osRelease.id "ubuntu" "debian" }}
echo "ðŸ“¦ Updating package lists..."
sudo apt-get update

echo "ðŸ“¦ Installing packages with APT..."
# Install light mode packages (always)
{{- range .packages.linux.apt.light }}
echo "Installing {{ . }}..."
sudo apt-get install -y {{ . | quote }}
{{- end }}

{{- if eq .installType "full" }}
# Install full mode packages (additional)
{{- range .packages.linux.apt.full }}
echo "Installing {{ . }}..."
sudo apt-get install -y {{ . | quote }}
{{- end }}
{{- end }}
    {{- else if eq .chezmoi.osRelease.id "fedora" "rhel" "centos" }}
echo "ðŸ“¦ Installing packages with DNF..."
# Install light mode packages (always)
{{- range .packages.linux.dnf.light }}
echo "Installing {{ . }}..."
sudo dnf install -y {{ . | quote }}
{{- end }}

{{- if eq .installType "full" }}
# Install full mode packages (additional)
{{- range .packages.linux.dnf.full }}
echo "Installing {{ . }}..."
sudo dnf install -y {{ . | quote }}
{{- end }}
{{- end }}
    {{- end }}
{{- else if eq .chezmoi.os "darwin" }}
if ! command -v brew >/dev/null 2>&1; then
    echo "âŒ Homebrew not found. Please install Homebrew first."
    exit 1
fi

echo "ðŸ“¦ Installing packages with Homebrew..."
# Install light mode packages (always)
{{- range .packages.darwin.brew.light }}
echo "Installing {{ . }}..."
brew install {{ . | quote }}
{{- end }}

{{- if eq .installType "full" }}
# Install full mode packages (additional)
{{- range .packages.darwin.brew.full }}
echo "Installing {{ . }}..."
brew install {{ . | quote }}
{{- end }}
{{- end }}
{{- end }}

echo "âœ… Development tools installation complete ({{ .installType }} mode)!"

# Install VS Code extensions if code command is available
# Skip in codespaces and dev containers as extensions are managed differently
{{- if and (not .codespaces) (not .devcontainer) }}
if command -v code >/dev/null 2>&1; then
    echo ""
    echo "ðŸ“¦ Installing VS Code extensions..."

    # Install common extensions
{{- range .extensions.common }}
    echo -n "Checking {{ . }}... "
    if code --list-extensions 2>/dev/null | grep -q "^{{ . }}$"; then
        echo "[OK]"
    else
        echo "Installing..."
        if code --install-extension {{ . | quote }} --force >/dev/null 2>&1; then
            echo "  [OK] {{ . }} installed"
        else
            echo "  [FAILED] Could not install {{ . }}"
        fi
    fi
{{- end }}

{{- if eq .chezmoi.os "linux" }}
    # Install Linux-specific extensions
{{- range .extensions.linux }}
    echo -n "Checking {{ . }}... "
    if code --list-extensions 2>/dev/null | grep -q "^{{ . }}$"; then
        echo "[OK]"
    else
        echo "Installing..."
        if code --install-extension {{ . | quote }} --force >/dev/null 2>&1; then
            echo "  [OK] {{ . }} installed"
        else
            echo "  [FAILED] Could not install {{ . }}"
        fi
    fi
{{- end }}
{{- else if eq .chezmoi.os "darwin" }}
    # Install macOS-specific extensions
{{- range .extensions.darwin }}
    echo -n "Checking {{ . }}... "
    if code --list-extensions 2>/dev/null | grep -q "^{{ . }}$"; then
        echo "[OK]"
    else
        echo "Installing..."
        if code --install-extension {{ . | quote }} --force >/dev/null 2>&1; then
            echo "  [OK] {{ . }} installed"
        else
            echo "  [FAILED] Could not install {{ . }}"
        fi
    fi
{{- end }}
{{- end }}

    echo "[OK] VS Code extensions installation complete!"
else
    echo ""
    echo "[SKIP] VS Code not found, skipping extension installation"
fi
{{- else }}
echo ""
echo "[SKIP] VS Code extensions skipped (codespace/devcontainer environment)"
{{- end }}

echo ""
echo "[COMPLETE] All installations finished!"

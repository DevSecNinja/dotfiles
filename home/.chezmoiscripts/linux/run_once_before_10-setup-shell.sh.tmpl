#!/bin/bash
# Setup default shell on Linux
#
# This script:
# 1. Attempts to set Fish as the default shell (preferred)
# 2. Falls back to zsh if Fish is not available
# 3. Adds the shell to /etc/shells if not already present
# 4. Sets the selected shell as default using chsh
#
# Note: This script requires sudo access for modifying /etc/shells

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# Logging functions
log_info() {
    echo -e "${WHITE}ℹ️  $*${NC}"
}

log_success() {
    echo -e "${GREEN}✅ $*${NC}"
}

log_warning() {
    echo -e "${YELLOW}⚠️  $*${NC}"
}

log_error() {
    echo -e "${RED}❌ $*${NC}"
}

# Only run on Linux
if [[ "{{ .chezmoi.os }}" != "linux" ]]; then
    log_info "Skipping shell setup (not on Linux)"
    exit 0
fi

log_info "Setting up default shell on Linux..."

# Detect available shells in priority order: fish > zsh
SHELL_PATH=""
SHELL_NAME=""

if command -v fish >/dev/null 2>&1; then
    SHELL_PATH="$(command -v fish)"
    SHELL_NAME="Fish"
    log_info "Detected Fish at: $SHELL_PATH"
elif command -v zsh >/dev/null 2>&1; then
    SHELL_PATH="$(command -v zsh)"
    SHELL_NAME="zsh"
    log_info "Detected zsh at: $SHELL_PATH"
else
    log_error "Neither Fish nor zsh found in PATH"
    log_info "Please install Fish or zsh and try again"
    exit 1
fi

# Verify shell version
if [[ "$SHELL_NAME" == "Fish" ]]; then
    SHELL_VERSION=$("$SHELL_PATH" --version 2>/dev/null | awk '{print $3}')
else
    # zsh --version outputs 'zsh X.Y.Z', so extract second field
    SHELL_VERSION=$("$SHELL_PATH" --version 2>/dev/null | awk '{print $2}')
fi
log_info "Found $SHELL_NAME version: $SHELL_VERSION"

# Check if shell is already in /etc/shells
if grep -q "^${SHELL_PATH}$" /etc/shells 2>/dev/null; then
    log_success "$SHELL_NAME is already in /etc/shells"
else
    log_warning "$SHELL_NAME is not in /etc/shells, adding it now..."
    log_info "This requires sudo access"

    if echo "$SHELL_PATH" | sudo tee -a /etc/shells >/dev/null; then
        log_success "Added $SHELL_PATH to /etc/shells"
    else
        log_error "Failed to add $SHELL_NAME to /etc/shells"
        exit 1
    fi
fi

# Check current shell
# Note: Using getent on Linux (portable across distributions)
# macOS uses: dscl . -read ~/ UserShell | awk '{print $2}'
CURRENT_SHELL=$(getent passwd "$USER" | cut -d: -f7)
log_info "Current shell: $CURRENT_SHELL"

# Change default shell if not already set
if [[ "$CURRENT_SHELL" == "$SHELL_PATH" ]]; then
    log_success "$SHELL_NAME is already your default shell"
else
    log_warning "Changing default shell to $SHELL_NAME..."

    if chsh -s "$SHELL_PATH"; then
        log_success "Default shell changed to $SHELL_NAME"
        log_info "Please restart your terminal for the changes to take effect"
    else
        log_error "Failed to change default shell to $SHELL_NAME"
        log_info "You can manually change it later with: chsh -s $SHELL_PATH"
        exit 1
    fi
fi

log_success "$SHELL_NAME shell setup completed successfully!"

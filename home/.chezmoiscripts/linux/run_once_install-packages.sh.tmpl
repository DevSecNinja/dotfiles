#!/bin/bash
# This script installs packages defined in .chezmoidata/packages.yaml
# Light mode: installs essential packages only
# Full mode: installs light + additional development packages

# Don't exit on error - we want to continue even if some packages fail
set +e

echo "ðŸ”§ Installing development tools ({{ .installType }} mode)..."

# Check if running with sudo privileges
if [ "$EUID" -eq 0 ]; then
    echo "âš ï¸  Running as root, commands will execute directly"
    SUDO_CMD=""
elif command -v sudo >/dev/null 2>&1; then
    SUDO_CMD="sudo"
else
    echo "âš ï¸  Warning: sudo is not available and not running as root"
    echo "   Skipping package installation as it requires elevated privileges"
    exit 0
fi

{{- if eq .chezmoi.os "linux" }}
    {{- if eq .chezmoi.osRelease.id "ubuntu" "debian" }}

echo "ðŸ“¦ Updating package lists..."
$SUDO_CMD apt-get update

echo "ðŸ“¦ Installing packages with APT..."
# Install light mode packages (always)
{{- range .packages.linux.apt.light }}
echo "Installing {{ . }}..."
if $SUDO_CMD apt-get install -y {{ . | quote }}; then
    echo "âœ… Successfully installed {{ . }}"
else
    exit_code=$?
    if [ $exit_code -eq 100 ]; then
        echo "âš ï¸  Warning: Package {{ . }} not found in repositories"
    else
        echo "âš ï¸  Warning: Failed to install {{ . }} (exit code: $exit_code)"
    fi
    echo "   Continuing with remaining packages..."
fi
{{- end }}

{{- if eq .installType "full" }}
# Install full mode packages (additional)
{{- range .packages.linux.apt.full }}
echo "Installing {{ . }}..."
if $SUDO_CMD apt-get install -y {{ . | quote }}; then
    echo "âœ… Successfully installed {{ . }}"
else
    exit_code=$?
    if [ $exit_code -eq 100 ]; then
        echo "âš ï¸  Warning: Package {{ . }} not found in repositories"
    else
        echo "âš ï¸  Warning: Failed to install {{ . }} (exit code: $exit_code)"
    fi
    echo "   Continuing with remaining packages..."
fi
{{- end }}
{{- end }}
    {{- else if eq .chezmoi.osRelease.id "fedora" "rhel" "centos" }}

echo "ðŸ“¦ Installing packages with DNF..."
# Install light mode packages (always)
{{- range .packages.linux.dnf.light }}
echo "Installing {{ . }}..."
if $SUDO_CMD dnf install -y {{ . | quote }}; then
    echo "âœ… Successfully installed {{ . }}"
else
    echo "âš ï¸  Warning: Failed to install {{ . }}"
    echo "   Continuing with remaining packages..."
fi
{{- end }}

{{- if eq .installType "full" }}
# Install full mode packages (additional)
{{- range .packages.linux.dnf.full }}
echo "Installing {{ . }}..."
if $SUDO_CMD dnf install -y {{ . | quote }}; then
    echo "âœ… Successfully installed {{ . }}"
else
    echo "âš ï¸  Warning: Failed to install {{ . }}"
    echo "   Continuing with remaining packages..."
fi
{{- end }}
{{- end }}
    {{- end }}

# Check if Homebrew packages are defined for Linux
{{- if or .packages.linux.brew.light .packages.linux.brew.full }}
echo ""
# Try to initialize Homebrew from standard locations if not already in PATH
if ! command -v brew >/dev/null 2>&1; then
    # Check standard Homebrew installation locations
    if [ -x "/home/linuxbrew/.linuxbrew/bin/brew" ]; then
        # Linux system-wide installation
        eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
    elif [ -x "$HOME/.linuxbrew/bin/brew" ]; then
        # Linux user-local installation
        eval "$($HOME/.linuxbrew/bin/brew shellenv)"
    fi
fi

if command -v brew >/dev/null 2>&1; then
    echo "ðŸ“¦ Installing packages with Homebrew..."
    {{- range .packages.linux.brew.light }}
    echo "Installing {{ . }}..."
    brew install {{ . | quote }}
    {{- end }}
    {{- if eq .installType "full" }}
    {{- range .packages.linux.brew.full }}
    echo "Installing {{ . }}..."
    brew install {{ . | quote }}
    {{- end }}
    {{- end }}
else
    echo "âš ï¸  Homebrew not available. Skipping Homebrew packages:"
    {{- range .packages.linux.brew.light }}
    echo "  - {{ . }} (not installed)"
    {{- end }}
    {{- if eq .installType "full" }}
    {{- range .packages.linux.brew.full }}
    echo "  - {{ . }} (not installed)"
    {{- end }}
    {{- end }}
    echo "â„¹ï¸  You can install Homebrew later from https://brew.sh"
fi
{{- end }}
{{- else if eq .chezmoi.os "darwin" }}
if ! command -v brew >/dev/null 2>&1; then
    echo "âŒ Homebrew not found. Please run the Homebrew installation script first."
    echo "   The script should have run automatically if you're in full mode."
    exit 1
fi

echo "ðŸ“¦ Installing packages with Homebrew..."
# Install light mode packages (always)
{{- range .packages.darwin.brew.light }}
echo "Installing {{ . }}..."
brew install {{ . | quote }}
{{- end }}

{{- if eq .installType "full" }}
# Install full mode packages (additional)
{{- range .packages.darwin.brew.full }}
echo "Installing {{ . }}..."
brew install {{ . | quote }}
{{- end }}
{{- end }}
{{- end }}

echo "âœ… Development tools installation complete ({{ .installType }} mode)!"

# Install VS Code extensions if code command is available
# Skip in codespaces and dev containers as extensions are managed differently
{{- if and (not .codespaces) (not .devcontainer) }}
if command -v code >/dev/null 2>&1; then
    echo ""
    echo "ðŸ“¦ Installing VS Code extensions..."

    # Install common extensions
{{- range .extensions.common }}
    echo -n "Checking {{ . }}... "
    if code --list-extensions 2>/dev/null | grep -q "^{{ . }}$"; then
        echo "[OK]"
    else
        echo "Installing..."
        if code --install-extension {{ . | quote }} --force >/dev/null 2>&1; then
            echo "  [OK] {{ . }} installed"
        else
            echo "  [FAILED] Could not install {{ . }}"
        fi
    fi
{{- end }}

{{- if eq .chezmoi.os "linux" }}
    # Install Linux-specific extensions
{{- range .extensions.linux }}
    echo -n "Checking {{ . }}... "
    if code --list-extensions 2>/dev/null | grep -q "^{{ . }}$"; then
        echo "[OK]"
    else
        echo "Installing..."
        if code --install-extension {{ . | quote }} --force >/dev/null 2>&1; then
            echo "  [OK] {{ . }} installed"
        else
            echo "  [FAILED] Could not install {{ . }}"
        fi
    fi
{{- end }}
{{- else if eq .chezmoi.os "darwin" }}
    # Install macOS-specific extensions
{{- range .extensions.darwin }}
    echo -n "Checking {{ . }}... "
    if code --list-extensions 2>/dev/null | grep -q "^{{ . }}$"; then
        echo "[OK]"
    else
        echo "Installing..."
        if code --install-extension {{ . | quote }} --force >/dev/null 2>&1; then
            echo "  [OK] {{ . }} installed"
        else
            echo "  [FAILED] Could not install {{ . }}"
        fi
    fi
{{- end }}
{{- end }}

    echo "[OK] VS Code extensions installation complete!"
else
    echo ""
    echo "[SKIP] VS Code not found, skipping extension installation"
fi
{{- else }}
echo ""
echo "[SKIP] VS Code extensions skipped (codespace/devcontainer environment)"
{{- end }}

echo ""
echo "[COMPLETE] All installations finished!"

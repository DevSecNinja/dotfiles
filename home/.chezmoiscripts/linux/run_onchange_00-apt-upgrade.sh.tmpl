#!/bin/bash
# Upgrades APT packages when chezmoi runs
#
# This script automatically checks for and upgrades APT packages during chezmoi update.
# Only runs on Debian/Ubuntu-based systems.
#
# Features:
# - Detection phase: Only runs if updates are available
# - Execution phase: 3-second countdown before upgrading (can be cancelled with Ctrl+C)
# - Checks for sudo availability and privileges
# - Skips countdown in CI/non-interactive environments
# - Skips on servers (hostname starts with SV*)
#
# Note: This is a regular run script that executes on every chezmoi update/apply

# {{ if and (eq .chezmoi.os "linux") (or (eq .chezmoi.osRelease.id "ubuntu") (eq .chezmoi.osRelease.id "debian")) (not .isServer) }}

set +e  # Continue on errors to avoid blocking chezmoi

echo ""
echo "================================================"
echo ">> APT Package Upgrade"
echo "================================================"

# Check if APT is available
if ! command -v apt-get >/dev/null 2>&1; then
    echo "[SKIP] APT not found on this system"
    exit 0
fi

echo ""
echo "[OK] APT package manager found"

# Check for sudo privileges
if [ "$EUID" -eq 0 ]; then
    SUDO_CMD=""
else
    if ! command -v sudo >/dev/null 2>&1; then
        echo "[WARN] sudo not available and not running as root"
        echo "       Skipping APT upgrade (requires elevated privileges)"
        exit 0
    fi
    SUDO_CMD="sudo"
fi

# Detection Phase: Check for updates
echo ""
echo "Detection Phase: Checking for updates..."

# Update package lists first
if ! $SUDO_CMD apt-get update >/dev/null 2>&1; then
    echo "[WARN] Failed to update package lists"
    echo "       Continuing anyway..."
fi

# Check if any upgrades are available
upgrade_check=$($SUDO_CMD apt-get upgrade --dry-run 2>/dev/null | grep -c "^Inst")

if [ "$upgrade_check" -eq 0 ]; then
    echo "[OK] All packages are up to date"
    exit 0
fi

echo "[OK] Found $upgrade_check package update(s) available"

# Countdown Phase (skip in CI/non-interactive)
countdown_seconds=3

if [ -n "$CI" ] || [ ! -t 0 ]; then
    echo ""
    echo "[SKIP] Skipping countdown (CI/non-interactive environment)"
else
    echo ""
    echo "Execution Phase: Starting upgrade in $countdown_seconds seconds..."
    echo "   Press Ctrl+C to cancel"

    for i in $(seq $countdown_seconds -1 1); do
        echo "   $i..."
        sleep 1
    done
    echo "   GO!"
fi

# Execution Phase: Perform upgrade
echo ""
echo ">> Starting package upgrades..."
echo ""

if $SUDO_CMD apt-get upgrade -y; then
    echo ""
    echo "================================================"
    echo "[OK] APT upgrade completed successfully"
    echo "================================================"
    exit 0
else
    exit_code=$?
    echo ""
    echo "================================================"
    echo "[WARN] APT upgrade completed with errors (exit code: $exit_code)"
    echo "================================================"
    exit 0  # Don't fail chezmoi
fi

# {{ else }}
# Not a Debian/Ubuntu system - skip silently
exit 0
# {{ end }}

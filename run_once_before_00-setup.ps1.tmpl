# PowerShell script that runs once after chezmoi init on Windows
# Use it for initial system setup

$ErrorActionPreference = "Stop"

Write-Host "üöÄ Running initial Windows setup..." -ForegroundColor Cyan

# Create necessary directories
$directories = @(
    "$env:USERPROFILE\bin",
    "$env:USERPROFILE\projects"
)

foreach ($dir in $directories) {
    if (-not (Test-Path $dir)) {
        Write-Host "Creating directory: $dir" -ForegroundColor Yellow
        New-Item -ItemType Directory -Path $dir -Force | Out-Null
    }
    else {
        Write-Host "‚úÖ Directory already exists: $dir" -ForegroundColor Green
    }
}

# Create symbolic link for config files if in WSL scenario
# (This helps when you want to share configs between WSL and Windows)
$wslConfigPath = "$env:USERPROFILE\.wslconfig"
if (-not (Test-Path $wslConfigPath)) {
    Write-Host "üí° Consider creating .wslconfig for WSL 2 optimization" -ForegroundColor Yellow
}

# Create symbolic link for PowerShell profile
$profileSource = "$env:USERPROFILE\.config\powershell\profile.ps1"
$profileTarget = $PROFILE

if (Test-Path $profileSource) {
    # Create profile directory if it doesn't exist
    $profileDir = Split-Path -Parent $profileTarget
    if (-not (Test-Path $profileDir)) {
        Write-Host "Creating PowerShell profile directory: $profileDir" -ForegroundColor Yellow
        New-Item -ItemType Directory -Path $profileDir -Force | Out-Null
    }

    # Create or update symbolic link
    if (Test-Path $profileTarget) {
        $existingItem = Get-Item $profileTarget
        if ($existingItem.LinkType -eq "SymbolicLink" -and $existingItem.Target -eq $profileSource) {
            Write-Host "‚úÖ PowerShell profile already linked correctly" -ForegroundColor Green
        } else {
            Write-Host "Removing existing profile and creating symbolic link..." -ForegroundColor Yellow
            Remove-Item $profileTarget -Force
            New-Item -ItemType SymbolicLink -Path $profileTarget -Target $profileSource -Force | Out-Null
            Write-Host "‚úÖ PowerShell profile linked to $profileSource" -ForegroundColor Green
        }
    } else {
        Write-Host "Creating PowerShell profile symbolic link..." -ForegroundColor Yellow
        New-Item -ItemType SymbolicLink -Path $profileTarget -Target $profileSource -Force | Out-Null
        Write-Host "‚úÖ PowerShell profile linked to $profileSource" -ForegroundColor Green
    }
} else {
    Write-Host "‚ö†Ô∏è  PowerShell profile source not found at $profileSource" -ForegroundColor Yellow
}

Write-Host "‚úÖ Initial Windows setup complete!" -ForegroundColor Green

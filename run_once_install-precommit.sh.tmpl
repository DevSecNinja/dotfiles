#!/bin/bash
# This script installs pre-commit for code quality checks
# Runs once per installation
# Only runs in devcontainer environments OR on dev servers (SVLDEV*)
# Skipped on light servers (SVL*)

set -e

{{- if eq .installType "light" }}
echo "â„¹ï¸  Skipping pre-commit installation (light server mode)"
exit 0
{{- end }}

if command -v pre-commit >/dev/null 2>&1; then
    echo "âœ… pre-commit already installed"
    exit 0
fi

# Check if running in a devcontainer
if [ -z "$REMOTE_CONTAINERS" ] && [ -z "$CODESPACES" ] && [ ! -f "/.dockerenv" ]; then
    echo "â„¹ï¸  Skipping pre-commit installation (not in a devcontainer)"
    exit 0
fi

echo "ðŸ“¦ Installing pre-commit..."

{{- if eq .chezmoi.os "linux" }}
# Linux - install pre-commit in a venv
VENV_DIR="$HOME/.local/venvs/pre-commit"

if [ ! -d "$VENV_DIR" ]; then
    echo "Creating venv for pre-commit..."
    python3 -m venv "$VENV_DIR"
fi

echo "Installing pre-commit in venv..."
"$VENV_DIR/bin/pip" install --upgrade pip
if [ -f "{{ .chezmoi.sourceDir }}/requirements.txt" ]; then
    "$VENV_DIR/bin/pip" install -r "{{ .chezmoi.sourceDir }}/requirements.txt"
else
    "$VENV_DIR/bin/pip" install pre-commit
fi

# Create symlink to make pre-commit available
mkdir -p "$HOME/.local/bin"
ln -sf "$VENV_DIR/bin/pre-commit" "$HOME/.local/bin/pre-commit"
export PATH="$HOME/.local/bin:$PATH"
{{- else if eq .chezmoi.os "darwin" }}
# macOS - prefer pipx or brew
if command -v pipx >/dev/null 2>&1; then
    pipx install pre-commit
elif command -v brew >/dev/null 2>&1; then
    brew install pre-commit
else
    if [ -f "{{ .chezmoi.sourceDir }}/requirements.txt" ]; then
        pip3 install --user -r "{{ .chezmoi.sourceDir }}/requirements.txt"
    else
        pip3 install --user pre-commit
    fi
fi
{{- end }}

# Ensure .local/bin is in PATH
export PATH="$HOME/.local/bin:$PATH"

echo "âœ… pre-commit installed successfully!"
echo "ðŸ’¡ To enable hooks, run: pre-commit install"
